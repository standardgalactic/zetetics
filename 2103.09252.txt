Draft version March 18, 2021
Typeset using LATEX twocolumn style in AASTeX63
Improved Contrast in Images of Exoplanets using Direct SNR Optimization
William Thompson
1, 2 and Christian Marois
2, 1
1 University of Victoria, Department of Physics and Astronomy,
3800 Finnerty Rd, Victoria, BC V8P 5C2, Canada
2 National Research Council of Canada Herzberg,
5071 West Saanich Rd, Victoria, BC, V9E 2E7, Canada
ABSTRACT
Direct imaging of exoplanets is usually limited by quasi-static speckles. These uncorrected aber-
rations in a star’s point spread function (PSF) obscure faint companions and limit the sensitivity
of high-contrast imaging instruments.
Most current approaches to processing diﬀerential imaging
sequences like angular diﬀerential imaging (ADI) and spectral diﬀerential imaging (SDI) produce a
self-calibrating dataset that are combined in a linear least squares solution to minimize the noise.
Due to temporal and chromatic evolution of a telescope’s PSF, the best correlated reference images
are usually the most contaminated by the planet, leading to self-subtraction and reducing the planet
throughput. In this paper, we present an algorithm that directly optimizes the non-linear equation for
planet signal to noise ratio (SNR). This new algorithm does not require us to reject adjacent reference
images and optimally balances noise reduction with self-subtraction. We then show how this algorithm
can be applied to multiple images simultaneously for a further reduction in correlated noise, directly
maximizing the SNR of the ﬁnal combined image. Finally, we demonstrate the technique on an il-
lustrative sequence of HR8799 using the new Julia-based Signal to Noise Analysis Pipeline (SNAP).
We show that SNR optimization can provide up to a 5× improvement in contrast close to the star.
Applicable to both new and archival data, this technique will allow for the detection of fainter, lower
mass, and closer in companions, or achieve the same sensitivity with less telescope time.
Keywords: planets and satellites: detection, methods: data analysis — techniques: image processing
— infrared: planetary systems
1. INTRODUCTION
Direct imaging of exoplanets oﬀers astronomers a
wealth of information – from initial detection and as-
trometry, to detailed orbital and spectroscopic charac-
terization. Due to the challenges of detecting faint com-
panions close to their stars, direct imaging is currently
limited in most cases to large, self luminous planets on
wide orbits. A major goal in the ﬁeld of direct imaging is
thus to improve the planet-to-star contrast ratio to im-
age fainter planets, closer to their stars. Evidence from
radial-velocity and direct imaging surveys suggest that
the occurrence rate of giant planets peaks near 2−3 AU
and increases with lower mass (Fernandes et al. 2019;
Corresponding author: William Thompson
wthompson@uvic.ca
Nielsen et al. 2020). Improving contrast close to stars is
therefore a clear path towards more direct detections.
Despite signiﬁcant progress over the past decade, the
dominant source of noise in direct imaging today re-
mains quasi-static speckle noise. This noise represents
aberrations in the point spread function (PSF) of the
atmosphere, telescope, and instrument that are not cor-
rected by the adaptive optics system, and have lifetimes
on the order of seconds to tens of minutes. These quasi-
static speckles are suﬃciently correlated between images
that simply averaging data over longer and longer in-
tegrations does not signiﬁcantly improve the ﬁnal con-
trast (Walker et al. 1998; Marois et al. 2003).
Since
speckle ﬁelds can be ﬁltered until only the component
that appears planet-like remains, these residual, long
living speckles appear identical to planets and can be
much brighter.
For quasi-static speckles, most observing strategies de-
pend on diﬀerential imaging. These are a range of tech-
arXiv:2103.09252v1  [astro-ph.IM]  16 Mar 2021

2
Thompson and Marois
niques, most notably angular diﬀerential imaging (ADI,
Marois et al. 2006a) and spectral diﬀerential imaging
(SDI, Walker et al. 1998; Racine et al. 1999; Marois et al.
2000) that produce a geometric oﬀset that varies from
image to image between the stellar PSF and any planets.
These images taken close in time and / or wavelength
can then serve to build a model of the stellar PSF that
ideally is representative of the speckle noise at each mo-
ment.
Most current algorithms based on LOCI (Lafreni`ere
et al. 2007) reduce diﬀerential imaging sequences by con-
sidering one image at a time—the “target image”—and
select a set of “reference images” from the other images
of the sequence.
Then, they ﬁnd the linear combina-
tion of reference images that, when subtracted from the
target image, create a “processed image” with minimial
residual noise. The images are usually divided into small
annular “subtraction regions” so that the model is spe-
cialized to the local noise distribution in the target im-
age. Finally, they transform all of the processed images
to align the signals of any planets and then stack them
to produce the ﬁnal output.
There are three challenges with this approach that
must be given careful consideration: over-subtraction,
overﬁtting, and self-subtraction. First, over-subtraction
occurs when an algorithm ﬁts the signal of the planet in
the target image using some combination of speckle noise
in the reference images and reduces planet throughput.
This can be mitigated by running the algorithm on a
separate “optimization region” paired with each sub-
traction region, and separating the two by a small buﬀer
to prevent the linear least-squares solution from incorpo-
rating any planets into its model. When the subtraction
and optimization regions are suﬃciently close together,
the speckle noise is typically correlated and the model
created using the optimization region is eﬀective at re-
moving speckles in the subtraction region.
Second, when the sutbraction and optimization re-
gions are separated, overﬁtting occurs when the model
becomes too specialized to the optimization region and
fails to generalize to the subtraction region, producing
a model that does not remove speckle noise eﬀectively.
There are several ways to control overﬁtting, but the
most common strategies all serve to reduce the dimen-
sionality of the model. This can be done by only select-
ing the reference images that are the most correlated
with the target image (LOCI, Lafreni`ere et al. 2007;
Marois et al. 2010a) or by linearly transforming the im-
ages into an orthogonal basis and only keeping the eigen-
images with the highest variance (KLIP/PCA, Soummer
et al. 2012). The size of the optimization regions and the
best number of reference images/eigenimages to include
are usually correlated, with larger optimization regions
being less specialized to the noise near the subtraction
region, but allowing the use of more reference images
before overﬁtting occurs.
Finally, and perhaps most importantly, planet self-
subtraction occurs when the signal of a planet is sup-
pressed by reference images contaminated with that
same planet. Linear methods have a strong tendency
towards selecting the most contaminated reference im-
ages in order to minimize the noise, since these are the
images that are the most correlated with the target im-
age. Traditionally, these reference images are rejected by
applying a threshold to the local planet displacement be-
tween images (e.g. due to varying paralactic over time),
the expected amount of ﬂux contamination via forward
modeling (TLOCI, Marois et al. 2010a), or other simi-
lar criteria. This limits self-subtraction at the expense of
increased noise, so this parameter (sometimes called the
aggressiveness) and other hyper-parameters are varied
to ﬁnd the combation that maximizes the SNR of in-
jected, forward modeled planets (Lafreni`ere et al. 2007;
Marois et al. 2010a; Soummer et al. 2012; Meshkat et al.
2014, and others).
Some amount of self-subtraction
is expected from these methods, so planet throughput
must be calibrated by injecting forward modeled planets
into the raw images.
Rejecting some of the most correlated references, fol-
lowed by minimizing the noise, and then correcting the
planet throughput might be sub-optimal. One improve-
ment to this was considered in Pueyo et al. (2012) in
the Damped-LOCI algorithm. In addition to limiting
spectral cross-talk when extracting spectra from SDI
sequences, Damped-LOCI aims to improve planet SNR
by simultaneously minimizing noise in the optimization
region and maximizing the variance in the subtraction
region, with an additional tunable hyper-parameter to
balance the tradeoﬀ. One possible issue with this ap-
proach is that by attempting to boost the variance in
the subtraction region, speckle noise under the planet
might be ampliﬁed.
To directly achieve an optimal planet signal to noise
ratio, we present a new algorithm in this paper that re-
frames the problem from minimizing the noise to directly
maximizing the signal to noise ratio (SNR) of any point
sources using the same forward modeling facilities im-
plemented in most pipelines for throughput correction.
This relatively straightforward approach allows us to use
any reference image regardless of it’s proximity to or ﬂux
contamination with the target image. This removes the
need to reject the most correlated reference images, and
removes the need to correct throughput loss due to self-
subtraction. Finally, this formulation can be generalized

Non-Linear SNR Optimization
3
Figure 1. Examples of the region geometry used this paper.
The annulus sector RS is the subtraction region and RO is
the optimization region. The optimization region is chosen
to be slightly thinner on the side closer to the star since the
brighter speckles in that area could bias the model towards
an overly aggressive solution. The white area between the
two regions is a buﬀer to prevent any planets from leaking
into the optimization region and causing over-subtraction.
The geometry of the regions can be chosen diﬀerently as
long a suﬃcient buﬀer is preserved between them to prevent
over-subtraction.
to treat multiple target images simultaneously so that
planet SNR in the overall stack of processed images is
optimized, further suppressing correlated noise.
This
approach is a general algorithm for maximizing the sig-
nal to noise ratio when combining measurements with
correlated noise, and a known variation in signal inten-
sity.
We begin by describing the new SNR optimization al-
gorithm. We show how it relates to linear methods like
LOCI in a limiting case, and why it should be expected
to meet or exceed the performance of linear methods
even when hyper-parameters of those methods are tuned
to maximize SNR. Next, we show how the algorithm can
be generalized to optimize a grid of multiple target and
reference images simultaneously and describe how this
can further reduce correlated noise in some sequences.
Finally, we analyze the performance of the SNR opti-
mization algorithm on a sample ADI sequence.
2. SNR OPTIMIZATION
To achieve an optimal planet signal to noise ratio, we
propose directly optimizing an expression for SNR in
each region of the sequence, instead of only minimizing
the noise. For a given location in the sequence, if we
know the relative photometry of a planet in each input
image by forward modeling, we can write a formula for
the planet SNR for any linear combination of images.
First, we divide the images into pairs of optimization
regions, RO, and subtraction regions, RS, just as in pre-
vious methods (Figure 1). For each pair of regions, we
consider a forward modeled planet centered in RS and
noise evaluated in RO. We use the noise in the opti-
mization region to ﬁnd a solution that we then apply to
the subtraction region. This makes the assumption that
the noise in the two regions are correlated, but is neces-
sary to avoid ﬁnding solutions that ﬁt the signals of any
planets using noise from the other images (called planet
over-subtraction). In previous works, authors have con-
sidered regions that partially overlap (beginning with
Lafreni`ere et al. 2007); however, the methods presented
here are aggressive enough that a buﬀer larger than ap-
proximately 0.4λ/D should be kept between the two re-
gions to prevent over-subtraction. Though we use the
noise in the optimization region, we are free to model
photometry for a planet located at the center of the
subtraction region in the target image.
The signal of a linear combination of images is then
simply the linear combination of the forward modeled
relative photometries in each image:
signal = p · c,
(1)
where p is a vector of forward modeled relative planet
photometry, and c is a vector of coeﬃcients for the lin-
ear combination of images. The forward model should
be calculated using either satellite spots (Marois et al.
2006b; Sivaramakrishnan & Oppenheimer 2006) on in-
struments where they are present, or an unocculted and
unsaturated PSF taken before or after the sequence.
This forward modeling is already implemented in most
direct imaging reduction pipelines for the purpose of
throughput correction (e.g. Marois et al. 2010a; Ruﬃo
et al. 2017).
By assuming that the noise is centered around zero,
we can write the noise as the root-mean-square (RMS)
of the pixel values in the same linear combination of
images
RMS =
v
u
u
t
M
X
j
(
N
X
i
Oijci)2/M
(2)
where i ranges from 1 to N, the number of images; j
ranges from 1 to M, the number of pixels; and O is a
matrix of N images by M pixels. The RMS is chosen
for simplicity and should be equivalent to the standard
deviation if a radial proﬁle is pre-subtracted, or the im-
ages are high-pass ﬁltered. Note that this does not as-
sume the underlying noise distribution is Gaussian, since
we are not using the RMS to calculate conﬁdence inter-
vals. Minimizing the RMS of any reasonable distribution
should minimize the noise in the images. It is possible

4
Thompson and Marois
that this metric could be tweaked to, for example, pe-
nalize spatially correlated noise, but this is outside the
scope of this paper.
By combining these expressions, we arrive at an equa-
tion for the signal to noise ratio of the modeled planet
for any given linear combination of images:
SNR = signal
RMS =
PN
i pici
qPM
j (PN
i Oijci)2/M
(3)
By noting that maximizing the SNR is equivalent to
maximizing an expression proportional to the SNR2, we
can see that this optimization problem is a quadratically
constrained quadratic problem:
argmaxc SNR=argmaxc SNR2
(4)
=argmaxc
PN
i pici
2
PM
j (PN
i Oijci)2
(5)
The values of the coeﬃcient vector c can then be cho-
sen such that the planet SNR is maximized. Applying
that vector of coeﬃcients to the subtraction region pro-
duces the linear combination of images that gives close
to the optimal planet SNR for that region, limited only
by the degree of correlation between the chosen opti-
mization and subtraction regions.
Since the SNR ratio is preserved if the c vector is
scaled by a constant, the problem is under constrained.
We therefore apply the additional constraint that the
planet-throughput is kept at unity, or
p · c = 1
(6)
Then, if the forward modeling is done with a correctly
scaled image of the same star, the resulting processed
image is then naturally in units of relative contrast. This
assumes that the planet forward model accurately re-
ﬂects changes in, for example, atmospheric variations,
or that these eﬀects are small.
2.1. Formulation as a constrained least-squares
problem
In order for this formulation to be useful, it must be
possible to eﬃciently optimize the coeﬃcients to ﬁnd a
global optimum. With the application of the constraint
in Equation (6), that is c · p = 1, we can express this
optimization problem as a constrained system of linear
equations as follows:
argmaxc SNR=argmaxc
1
qPM
j (PN
i Oijci)2
(7)
=argminc
v
u
u
t
M
X
j
(
N
X
i
Oijci)2
(8)
=argminc |Oc|
(9)
subject to c · p = 1
(10)
This ﬁnds the linear combination of reference images
that minimizes the noise in the optimization zone, sub-
ject to the constraint that the throughput is preserved
at unity.
Without the constraint, the solution would
have all c = 0 and the output image would be entirely
empty. With this formulation, the photometry vector
p decides which is the “target” image. The target im-
age has its own coeﬃcient, just like a reference. Since
we chose to model the planet photometry with a planet
centered in the subtraction zone of the target image, the
index of the target image should correspond to the max-
imum value of p, and likely (though not necessarily) the
highest value in c as well.
This formulation is a valid expression in the method-
ology of Disciplined Convex Programming (DCP, Grant
et al. 2006).
Many programming languages have li-
braries that can solve such expressions eﬃciently to a
global optimum.
In some cases, such as when using Reference Star
Diﬀerential Imaging (RSDI) to “star-hop” between two
stars, images with signiﬁcant ﬂux contamination and im-
ages with no contamination are intermixed. In this case,
the constraints can be treated as sparse since only im-
ages with signiﬁcant planet ﬂux contribution must enter
into the constraint term.
2.2. Reduction to Linear Least Squares in limit of no
self-subtraction
To show how this method relates to previous algo-
rithms, we show that SNR optimization reduces to a
linear problem if we neglect planet contamination in the
reference images. This situation would occur if a target
image was reduced using only reference images taken
from another star (RSDI) or if all neighboring reference
images were rejected (e.g. in LOCI based algorithms).
Taking the target image to be i = 1, then p1 = 1, all
other pi = 0, and c1 = 1 due to the throughput con-
straint. Equation (5) then reduces to:
argmaxc
1
PM
j=1(
PN
i=1 Oijci)
2
(11)
= argminc
PM
j=1

O1j + PN
i=2 Oijci
2
(12)
Continuing now as in Lafreni`ere et al. (2007), the min-
imum occurs when all of the partial derivatives with re-
spect to c are zero:

Non-Linear SNR Optimization
5
δ
δck
M
X
j=1
 
O1j +
N
X
i=2
Oijci
!2
=0, ∀k
(13)
(14)
M
X
j=1
OkjO1j =
N
X
i=2
−ci


M
X
j=1
OijOkj

, ∀k
(15)
Which is the familiar system of linear equations of the
form Ax = b where
Aik =
M
X
j=1
OijOkj,
xk = −ck,
and bk =
M
X
j=1
OkjO1j.
(16)
This is exactly equation 7 of Lafreni`ere et al. (2007)
apart from notational diﬀerences and the sign conven-
tion on c.
We can therefore consider SNR optimiza-
tion to be a generalization of LOCI for reference images
that contain overlapping ﬂux from the planet.
Since
this occurs in almost every ADI or SDI reduction, we
can expect the resulting SNR to always be higher when
using SNR optimization for the same set of references—
ignoring secondary eﬀects such as how well the solution
generalizes from the optimization region to the subtrac-
tion region. Note that SNR optimization could be used
directly on the subtraction regions analogously to some
LOCI pipelines; however, in this paper we maintain a
buﬀer to prevent oversubtraction. Example target im-
ages reduced with both LOCI and SNR optimization are
presented in Section 5.
This also shows that we cannot further improve RSDI
sequences since the two formulations would reduce to
the same system of linear equations. If a sequence also
contains ﬁeld of view rotation or multiple wavelengths
in addition to the reference images, this algorithm can
still oﬀer improved SNR by better handling the images
that do have planet ﬂux contamination.
3. MULTI-TARGET IMAGE OPTIMIZATION
In Section 2, we described the process of applying SNR
optimization to a single target image with a set of ref-
erence images. The results of each image must then be
rotated and/or scaled to re-align the signals of any plan-
ets and then stacked, just as in previous approaches. A
limitation of this single-target optimization is the as-
sumption that solutions giving the highest SNR for an
individual target image also lead to the highest SNR in
the stacked image.
This is a reasonable assumption to ﬁrst order, but is
often violated at close separations. For example, there
are often bright, randomly ﬂuctuating speckles in ad-
dition to a ﬂoor of dimmer, more consistent speckles.
When considering each target individually, the SNR is
maximized by suppressing the bright, ﬂuctuating speck-
les, perhaps at the expense of the dimmer ones; however,
in the ﬁnal stack, it may be the dimmer persistent speck-
les that are correlated between images that contribute
the most noise.
It is therefore worth considering ways to avoid this as-
sumption. Since the SNR equations above do not distin-
guish between target images and reference images except
by how the forward modeled photometry is calculated,
it is possible to combine multiple target images into a
single optimization problem.
The output of the opti-
mization algorithm then becomes a single, larger set of
coeﬃcients that describes both how each target image is
combined with its matching references, and how those
resulting images are combined into the ﬁnal processed
image.
There are three steps to preparing this problem. First,
transform the target images to align any planet signals
(usually by rotating them North-up). Then, transform
copies of each reference image so that its speckles are
aligned with each transformed target image.
This is
best visualized as a grid of reference images with the
target images placed along the diagonal (see Figure 2).
Finally, generate subtraction and optimization regions
that are in physical coordinates (e.g. North-up), rather
than in the coordinates of the detector.
At this point, the algorithm can continue as usual,
with a few adjustments to how the forward modeled
photometry is calculated to account for those coordinate
transformations. If all the target images are combined
into a single problem, then there is no need to stack the
results using a median or other statistic. Applying the
coeﬃcients to the subtraction region produces a single
output image.
At ﬁrst glance, this appears to increase the size of
the model from N images or eigenimages to N 2 images;
however, the total number of coeﬃcients to calculate is
the same. Looking again at Figure 2, standard linear
methods or SNR optimization would calculate a coef-
ﬁcient for each image, on N-image column at a time,
and the then stack the resulting processed images. If
an arithmetic mean is used to stack the residuals, it’s
clear that the output consists of a linear combination of
N × N images in either case.
By directly optimizing the SNR of that combination,
we no longer assume that each target image is indepen-
dent, and that the brightest noise, regardless of its tem-
poral evolution, contributes the most to the ﬁnal result.
Secondly, we also use information in the optimization

6
Thompson and Marois
N
Calibrated 
Images
N x N
Prepared 
Images
Planets
North-up
Planets
North-up
Speckles
matched to 1
Speckles 
matched to 2
Speckles
matched to 1
Speckles
matched to 2
Planet
Speckles
Image
Legend
Speckles
matched to 3
Speckles
matched to 3
Planets
North-up
1
2
3
1
2
3
Figure 2. Preparing a grid of N images for multi-target SNR optimization. In this example of a simpliﬁed 3-image ADI
sequence, a distorted star shape represents the star’s PSF and a small circle represents a planet directly to the North of the star.
We begin by transforming each target such that any companion would appear in their physical, e.g. North-up, locations (the
diagonal elements). Next, for each transformed target, we apply the same transformation to each corresponding reference (the
oﬀ-diagonals). This aligns the speckles in the references with the speckles in that transformed target. We then follow the usual
approach of dividing the ﬁeld into annuli or annulus sectors for local optimization. An analogous matrix is prepared for the
relative photometry using forward modeling for each region. In previous approaches, one would eﬀectively reduce each column
of this grid independently and then stack the results. By preparing this grid of transformed images as a single problem, the
optimizer becomes aware of noise that is correlated between target images, and we achieve a higher point source SNR in the
ﬁnal stacked image.
region to guide how much weight should be given to
each column of the grid, rather than giving each target
image an equal weight. A comparison of the formance
of single-target versus multi-target SNR optimization is
presented in Section 5.
3.1. Batching
Multi-target SNR optimization is useful for improv-
ing noise that is correlated between target images, and
that is correlated between the subtraction and optimiza-
tion region, but that does not dominate until multiple
reduced images are stacked. On the other hand, a tra-
ditional stacking technique like a median is more eﬀec-
tive at rejecting large outliers that are not spatially and
temporally correlated since it operates inside the sub-
traction region.
These two techniques can be balanced by dividing
the grid into groups of columns called batches. Opti-
mization can proceed one batch at a time to produce a
smaller set of output images. The residuals can then be
stacked analogously to per-target optimization, though
without needing to ﬁrst rotate or otherwise transform

Non-Linear SNR Optimization
7
the results. By grouping correlated targets together and
then stacking the results, we retain most of the corre-
lated noise rejection and the outlier rejection of a me-
dian. We can then see that multi-target SNR optimiza-
tion is a spectrum, ranging from considering only a sin-
gle target at a time to an entire sequence. For the same
contrast, smaller batches have an additional beneﬁt of
reducing the computational cost of the reduction.
In principle, a correlation analysis could be used to
group target images into batches, but a simple method
is to group targets according to the time they were cap-
tured since images captured close in time are likely to be
the most correlated. The ideal size of a batch depends
on both the sequence and instrument. It should be suﬃ-
ciently large that target images outside the batch are no
longer highly correlated, but of suﬃcient number that
outliers can be rejected with a median. This parameter
can be optimized for each sequence or estimated by ﬁrst
reducing the sequence using single-target optimization
and estimating the residual speckle lifetime.
Finally, the target batches do not need to be disjoint.
It is reasonable to have, for example, a batch size of ﬁf-
teen targets that advances ﬁve target images per batch.
This slightly improves robustness against outliers at the
expense of increased computation time. An example of
batched of multi-target SNR optimization is presented
in Section 5.
3.2. Controlling Overﬁtting
In the context of diﬀerential imaging, overﬁtting oc-
curs when a model is given too much ﬂexibility and in-
suﬃcient data. For example, this can occur if hundreds
of reference images are used with a small optimization
region to reduce one target image. The large set of ref-
erences may be combined in such a way that random
read noise, photon noise, or a transient speckle in the
optimization region is minimized, but the solution does
not eﬀectively generalize to the noise in the subtraction
region. This limits the performance of an algorithm but
should not bias the signal of any planets as long as suf-
ﬁcient buﬀers are maintained.
Overﬁtting can be limited in several ways. First, one
can restrict the set of reference images to only include
those most correlated to the target (Marois et al. 2010a).
Second, one can perform an SVD (Marois et al. 2010a)
or PCA analysis (Soummer et al. 2012), and similarly
restrict the set of eigenimages. Third, one can increase
the size of the optimization regions until there is suﬃ-
cient data to train the model (though if the optimization
regions are too large, the model may not be suﬃciently
specialized to the local noise distribution). Another op-
tion is to introduce a regularization term to the model
to penalize overly complex combinations of coeﬃcients.
Lastly, one average multiple reductions with variations
in their parameters to reduce the impact of overﬁtting
(sometimes referred to as “bagging”).
The challenge of overﬁtting is exacerbated with multi-
target SNR optimization. When many target images are
combined into a single problem, the size of the reference
set must grow quadratically. Unfortunately, SNR op-
timization is a non-linear process that does not admit
a simple PCA solution. Such a solution would need to
decompose the system of quadratic equations into non-
linear “SNR modes.” Instead, we approach the problem
of overﬁtting by combining four of the above techniques.
First, we eliminate poorly correlated reference images
from the grid, reducing the model size. Next, we add an
L2 regularization parameter into the objective. Finally,
we divide the sequence of target images into overlap-
ping batches, and average their results. Each of these
hyper-parameters can be optimized in turn to arrive at
a balance that is ideal for any given sequence.
This
tuning process can be relatively eﬃcient when using an
optimizer that supports warm-starting from a previous
solution.
When tuning hyper-parameters, it is best to use a
stand-in such as a separate validation region, or set of
prepared images with rotation reversed. By tuning the
algorithm on this diﬀerent but statistically similar data,
we ensure that the hyper-parameters are not biased to-
wards combinations that, by chance, reduce the ﬂux of
any planets and diminish overall throughput.
4. IMPLEMENTATION
The full algorithm for multi-target image SNR opti-
mization with regularization is presented succinctly in
Algorithm 1. This takes both the number of most cor-
related references to include and the regularization pa-
rameter α to limit overﬁtting. It also takes the number
of images in a batch to control the trade oﬀbetween out-
lier rejection (Nbatch = 1) and reducing correlated noise
(Nbatch = Nimages). These hyper-parameters should be
tuned for each sequence. The image preparation steps
on lines 4 and 5 can be generalized for any type of dif-
ferential imaging. We do not include hyper-parameter
optimization steps for the geometry of the subtraction
and optimization regions, as these are physically mo-
tivated, relatively insensitive, and already discussed in
previous works (Lafreni`ere et al. 2007; ?)
To apply the algorithm, we built a new Signal to
Noise Analysis Pipeline (SNAP). Implemented in Ju-
lia (Bezanson et al. 2012), it can process sequences with
RDI, ADI, SDI from Keck NIRC2 (PI: K. Matthews),
VLT-SPHERE (Beuzit et al. 2019), GPI (Macintosh

8
Thompson and Marois
Algorithm 1: Multi-Target Image SNR Optimization for ADI.
procedure SNROpt(images, regions, Nbatch, Nrefs, α)
for i ∈1 : Nimages do
▷Prepare images
θtarg ←PA(images[i]) for j ∈1 : Nimages do
prepared[i, j] ←rotate(images[j], θtarg)
end
end
for i ∈1 : Nbatch : Nimages do
▷Iterate through batches
for k ∈1 : Nbatch do
▷For each target in batch, select references
selected[k] ←Nrefs most correlated references in column k of batch
end
foreach (RS, RO) ∈regions do
▷Iterate through each pair of regions
p ←model photometry of selected in Rs for planet centered in targets
O ←RO regions of selected images
c ←argmin
Oc + α PN
i c2
i

subject to c · p = 1
▷Optimize SNR in optimization region
S ←RS regions of selected images
outi[RS] ←Sc
▷Apply coeﬃcients to subtraction region
end
end
Measure contrast curves of for each outi and take the weighted median
end procedure
The hyper-parameters Nbatch, Nrefs, and α should be optimized against either a separate validation region Rv or by
reversing the angle θtarg. This ensures values are not selected that, by chance, hurt the throughput of any planets in RS.
et al. 2014), and LBT LMIRCam (Skrutskie et al. 2010).
Single-image and multi-target image SNR optimization
is supported along with LOCI and TLOCI-style algo-
rithms for the sake of comparison. The LOCI style algo-
rithms include optimization steps for the number of ref-
erence images and rejection threshold, making it roughly
comparable to other “optimized” implementations like
Meshkat et al. (2014).
To abstract RDI, ADI, and SDI as a single pro-
cess, we used the library CoordinateTransforms.jl
to store arbitrary transformations between speckle-
aligned coordinates and planet-aligned coordinates. For
multi-target image SNR optimization, we combined
these transformation objects with WarpedViews from the
ImageTransformations.jl package. This allows us to
avoid storing duplicates of each reference image trans-
formed to match each target. When a given pixel of a
reference image is required, the transformation and in-
terpolation are performed on the ﬂy. This reduces the
number of prepared reference images stored in memory
from N 2 to simply N, and removes much of the memory
overhead for multi-target SNR optimization.
Forward modeling is also necessary for the SNR opti-
mization algorithm. To this end, the pipeline uses the
transformation objects to compute a model for a planet
in each subtraction region for each second of the se-
quence to account for the rotational smearing that takes
place during ADI integrations. These abstractions allow
the pipeline to straightforwardly optimize the stacked
SNR of a sequence containing multiple wavelengths and
rotation angles without knowing the details of the trans-
formations applied to the images.
For the SNR optimization itself, we implemented two
modules.
The ﬁrst uses either Newton’s method or
BFGS (Fletcher 1987; Mogensen & Riseth 2018) to di-
rectly optimize the SNR using Equation (5) and its par-
tial derivatives. This performs very well on smaller prob-
lems up to a few hundred reference images. On larger
problem sizes, Convex.jl (Udell et al. 2014) with the
COSMO.jl (Garstka et al. 2019) backend is used with
Equation (10).
This outperforms the direct solution,
and is particularly eﬃcient on multi-target image SNR
optimization problems which may have Hessians with
very high condition numbers (> 107).
5. DEMONSTRATION
We evaluated the performance of the SNAP pipeline
on an ADI sequence taken of HR8799 (Marois et al.
2008) with NIRC2 at Keck on 2020 November 17 (PI:
Q. Konopacky). The sequence consists of 90 separate 40-
second integrations taken at L′ band while the system
transited the meridian. We took the sequence in good
seeing without a coronagraph, causing the central core of
the star to saturate. We acquired separate unsaturated
images at the beginning and end of the sequence.
We reduced the sequence three times using the same
code, changing only whether the coeﬃcients were se-
lected by our baseline implementation of LOCI, by
single-target image SNR optimization, or by multi-
target image SNR optimization. This reduces the like-

Non-Linear SNR Optimization
9
Figure 3.
Three examples of target images reduced with both LOCI (top) and with SNR optimization (bottom).
Each
example was taken from a diﬀerent part of the sequence with diﬀerent FoV. rotation rates. In all three examples, we see that
SNR optimization is very eﬀective at suppressing speckles from the star. Images are displayed on the same color scale.
0
20
40
60
80
image #
0.2
0.0
0.2
0.4
0.6
0.8
1.0
coefficient
LOCI
LOCI rejected image
Single-target SNR Opt
Figure 4.
The coeﬃcients chosen by LOCI and by SNR
optimization for the images shown in the third column of
Figure 3 and a region close to planet HR8799e. The black
line shows the coeﬃcients chosen by the LOCI algorithm for
the target image # 60.
The red squares indicate images
that were rejected for the LOCI reduction due to insuﬃcient
displacement from the target. The orange line, on the other
hand, shows the coeﬃcients that give the highest SNR. Note
that in SNR optimization, the target image is treated just
like a reference image with a coeﬃcient.
lihood that any unrelated diﬀerences between imple-
mentations aﬀect the results. For all three algorithms,
hyper-parameters such as the number of reference im-
ages and the regularization were independently opti-
mized to select their best values for this sequence. That
said, general details such as the geometry of the op-
timization and subtraction regions were chosen to give
the best performance using SNR optimization—it’s pos-
sible that these, or other choices are not ideal values
for LOCI style algorithms, and that comparable results
could be achieved given suﬃcient eﬀort. It is challeng-
ing to compare diﬀerent algorithms across sequences and
instruments in a completely fair way, so this should be
considered only as an illustrative example for how SNR
optimization performs.
For this sequence we used subtraction regions that are
annulus sectors 1.4λ/D thick and 180◦wide, and opti-
mization regions that surround the subtraction regions
with 2λ/D on the outside, and 1.2λ/D on the inner side.
A buﬀer of 0.4λ/D separates the two to prevent over-
subtraction. See Figure 1 for a schematic.
To tune the hyper-parameters of SNR optimization,
we increased the number of included reference images
and the L2 regularization parameter until the forward
modeled SNR stopped improving.
For LOCI, the re-

10
Thompson and Marois
Figure 5. The beneﬁts of multi-target SNR optimization on one batch of ten images. Top: Target images reduced individually
with SNR optimization. A white arrow points to an example of noise that is correlated between nine out of the ten images.
Bottom left: Median stack of the ten images at the top. The highly correlated residuals are not rejected by the median.
Bottom right: The same images reduced simultaneously with multi-target image SNR optimization. By considering the ten
targets simultaneously, we prevent the buildup of correlated noise between targets. The blue arrows highlight locations where
noise that was correlated between the ten target images was suppressed by multi-target SNR optimization. The red arrow shows
a counter example where multi-target SNR optimization fails to reject a bad pixel. Taking the median of multiple batches is an
eﬀective way to suppress these cosmetics. Images are in units of brightness relative to the star.
jection window and the number of included reference
images were similarly adjusted. We tuned the hyper-
parameters using the backwards-rotated set of images to
avoid unintentionally favoring solutions that bias planet
photometry and risk losing planet throughput. In both
cases, the reference images were ranked against each tar-
get by their correlation to the subtraction region. Fi-
nally, the LOCI images were throughput corrected us-
ing forward modeling in order to match the results of
SNR optimization.
This may lead it to look qualita-
tively worse than similar images in the literature where
thoughput correction might be neglected but reﬂects the
true ability of the algorithm to recover planets.
We begin by examining three individual target im-
ages, # 9, 31, and 60, reduced with LOCI and with
single-target image SNR optimization (Figure 3). The
new algorithm signiﬁcantly outperforms the baseline re-
duction and reveals the innermost known planet (Marois

Non-Linear SNR Optimization
11
Figure 6.
A non-coronagraphic L′-band ADI sequence taken of HR8799 at Keck, reduced with LOCI (left), single-target image
SNR optimization (middle), and multi-target image SNR optimization (right). While HR8799e is near the level of the noise in
the LOCI reduction, the new algorithm recovers it robustly and even recovers usable data from behind the ﬁrst Airy ring of the
stellar PSF. The central 1.2 λ/D region marked in white is saturated. The outputs of the three algorithms are each combined
in a contrast weighted median, which tends to favor images with the highest FoV rotation rate—hence the uncharacteristically
faint dark wings in the LOCI reduction. Much of the central 500 mas in the left panel is outside the plotted color scale.
et al. 2010b). In Figure 4, we compare the coeﬃcients
chosen by both algorithms for a subtraction region near
planet HR8799e. For the sake of comparison, we adopt
the convention that the target image has a coeﬃcient
held at 1 for the LOCI reduction. Reference images that
lie within the LOCI rejection window are considered as
having coeﬃcients held at 0.
The diﬀerence in the chosen coeﬃcients for the linear
combination is striking. The images that were rejected
by LOCI for having too much overlap are used to a sig-
niﬁcant extent by SNR optimization. Surprisingly, one
of the directly adjacent reference images was subtracted
from the target, despite signiﬁcant planet overlap. This
may indicate that SNR optimization is compensating
for a poor quality image using its neighbors. This, and
other surprising deviations from the coeﬃcients chosen
by LOCI shows that there is signiﬁcant room for the
new algorithm to outperform existing techniques.
Next, we compare ten target images reduced with
single- and multi-target SNR optimization.
Figure 5
shows the ten images each reduced independently with
SNR optimization. Many areas of the reduced images
are highly correlated from image to image. The informa-
tion necessary to remove these speckles must therefore
be present in the reference images; however, it was not
used.
This could be because removing those speckles
would have been a poor trade oﬀfor the SNR of a single
reduced image. When stacked, these residual correlated
speckles remain, limiting the SNR of the ﬁnal image.
When the ten target images are considered simultane-
ously, however, the objective function is sensitive to the
ﬁnal combined SNR, and therefore ﬁnds a better over-
all solution. This shows that reducing correlated target
images in batches prevents the build up of correlated
residuals in the ﬁnal stack.
Finally, we examine the full reduction of the sequence
with LOCI and SNR optimization. We adopt a batch
size of ten target images, and advance the window ﬁve
targets at a time (i.e.
producing 16 output images).
The processed images from LOCI and SNR optimization
were stacked using a contrast-weighted median where
the contrast was evaluated using a matching backwards-
rotated reduction to prevent planet signals from biasing
the weights. The ﬁnal outputs of the two algorithms are
shown in Figure 6. The images are cropped to the inner
region of the system to highlight the improvement close
to the star.
Planets b, c and d (Marois et al. 2008) are recovered
in both reductions, while planet e (Marois et al. 2010b)
is only recovered robustly from this sequence using the
new algorithm. Though the performance of both types
of algorithm are comparable at wider separations, re-

12
Thompson and Marois
10
5.0
10
4.5
10
4.0
10
3.5
10
3.0
5  contrast
0
2
4
6
8
10
12
14
Separation  /D
0
20
40
60
80
improvement
Raw
LOCI
Single-target SNR Opt
Multi-target SNR Opt
Figure 7. Top: planet-to-star contrast compared for the
diﬀerent reductions, and one raw image.
Bottom: Con-
trast improvement compared to the raw image. Multi-target
SNR optimization outperforms LOCI by three to ﬁve times
at small separations from the star, and achieves a consistent
10-20% improvement at wide separations.
gions closer to the star are dramatically improved. We
hypothesize that the improved performance is due to
its more optimal treatment of the reference images that
overlap with the target image, and its use of multi-target
SNR optimization to limit the build up of correlated
noise.
The shapes of the planet PSFs and negative side-lobes
are quite diﬀerent between the two reductions, indicat-
ing that SNR optimization chooses very diﬀerent coef-
ﬁcients. Unlike LOCI, SNR optimization is free to add
adjacent reference images, or even improve the planet
signal using the ﬁrst Airy ring of the planet from a ref-
erence image. The net eﬀect at small separations from
the star is typically a broader planet PSF than LOCI.
Figure 7 shows the contrast improvement of each algo-
rithm compared to a raw image. We ﬁnd that at wider
separations, the contrast was improved by roughly 20%,
while at smaller separations, the contrast was improved
by nearly 5 times.
Figure 8 shows histograms of the pixel values of a re-
gion close to the star for the three fully reduced images.
The spread of pixel values is much narrower in the SNR
optimization reductions, and is also more symmetrical
with fewer outliers. Figure 9 shows how, in addition to
producing images with lower residual noise, SNR opti-
mization can also produce residuals whose distribution
more closely resembles a Gaussian.
This reduces the
eﬀects of non-Gaussian noise on detection, astrometry,
and photometry conﬁdence intervals.
6. DISCUSSION
Now, we discuss a few considerations when applying
this technique and directions that warrant further study.
First, there may be sequences where LOCI outper-
forms single-target image SNR optimization because a
more aggressive subtraction, while sub-optimal for each
processed image, improves the ﬁnal stacked image. The
core of the SNR optimization algorithm is parameter-
free, so it is not possible to tune the aggressiveness to
replicate this eﬀect.
Instead, multi-target SNR opti-
mization should be used so that an optimal solution for
the ﬁnal stacked image is found.
Compared to using
LOCI with a tuned aggressiveness, this does rely more
heavily on the assumption that the subtraction and op-
timization regions are well correlated.
Second, this technique does not permit a straightfor-
ward application of PCA methods which are useful for
rejecting noise on some sequences. A potential future
direction would be to transform the images into an ap-
proximately orthogonal basis for the SNR function. In
the meantime, an archive of images collected from refer-
ence stars or images where the planet PSF does not over-
lap with the target image could still be used to generate
an orthogonal basis using an algorithm like KLIP. These
eigenimages could then be used in combination with the
overlapping reference images to combine the strengths
of both algorithms. The use of a regularization param-
eter as described in Section 3.2 should achieve a similar
result by favoring solutions with lower complexity.
Third, this method may distort a planet’s PSF, shift-
ing its apparent centroid and aﬀecting its photometry.
Just as with previous techniques, astrometry and pho-
tometry can be extracted robustly using forward model-
ing (described in Marois et al. 2010a; Galicher & Marois
2011).
Ultimately, it could be combined with a full
forward-model matched ﬁlter Ruﬃo et al. (2017) to fur-
ther improve the contrast. In general many additional
steps and constraints have been shown to improve the
performance of linear methods, and will likely be equally
applicable to SNR optimization.
Finally, SNR optimization has a higher computational
complexity than solving a system of linear equations.
When combined with multi-target SNR optimization on

Non-Linear SNR Optimization
13
0
10
20
30
contrast ×10 ³
100
101
102
103
104
counts
Raw
4
2
0
2
4
contrast ×10 ³
100
101
102
103
104
LOCI
4
2
0
2
4
contrast ×10 ³
100
101
102
103
104
Single-target SNR Opt  
4
2
0
2
4
contrast ×10 ³
100
101
102
103
104
Multi-target SNR Opt
Figure 8. Histograms of residual noise in the inner 3 λ/D region around the star for one raw image and the reduced images
presented in Figure 6. In addition to the lower overall noise, SNR optimization produces residuals with a more symmetric
distribution on this sequence.
0
1
2
3
4
5
pixel value / 
3
2
1
0
probability  log
Raw
LOCI
Single-target SNR Opt  
Multi-target SNR Opt  
Gaussian
Figure 9. Comparison of the pixel distributions between the
diﬀerent algorithms and one raw image. The values shown
are 1 - the cumulative distribution of pixel values taken from
an annulus between 500 and 600 milliarseconds, normalized
to one standard deviation and integrated symmetrically from
zero. The algorithm presented in this paper produces resid-
uals with a distribution that more closely resembles a Gaus-
sian.
a large sequence, the computational cost becomes sig-
niﬁcant. Our Julia-based SNAP implementation is able
to reduce a single wavelength ADI sequence in roughly
two hours on a 2015 Mac Pro workstation, or in just
a few minutes when restricting the space explored by
hyper-parameter tuning. Large SDI sequences can push
the computational requirements higher such that a com-
pute cluster becomes more appropriate.
7. CONCLUSION
We have presented a new algorithm for processing
high contrast images based the direct optimization of the
non-linear SNR function. We showed that this approach
improves on previous techniques that ﬁnd linear least
squares solutions that minimize the noise, even if the pa-
rameters like aggressiveness are optimized. The new al-
gorithm no longer requires us to reject reference images
taken too close in time or wavelength. We also showed
how this new formulation allows us to reduce multiple
target images simultaneously. This allows the optimizer
to work across the entire sequence, taking into account
the temporal coherence of noise in addition to its spa-
tial properties, and delivering optimized full-stack SNR.
Finally, we presented our implementation in SNAP, the
Signal to Noise Analysis Pipeline, and demonstrated a
signiﬁcant improvement to contrast in the challenging
region close to the star. We expect this algorithm will
improve the contrast of ground based facility-class in-
struments and future ﬂagship space missions. This will
enable the detection of fainter, lower mass, and closer
in companions, or achieve the same sensitivity with less
telescope time.
8. ACKNOWLEDGMENTS
We thank Q. Konopacky for allowing us to partici-
pate in the Keck NIRC2 HR8799 L′ campaign and use
the data in this paper. We also thank the anonymous
referee whose suggestions improved this paper. We ac-
knowledge the support of the Natural Sciences and Engi-
neering Research Council of Canada (NSERC) and New
Technologies for Canadian Observatories (NTCO) pro-
gram. The data presented herein were obtained at the
W. M. Keck Observatory, which is operated as a scien-
tiﬁc partnership among the California Institute of Tech-

14
Thompson and Marois
nology, the University of California and the National
Aeronautics and Space Administration. The Observa-
tory was made possible by the generous ﬁnancial sup-
port of the W. M. Keck Foundation. This research was
enabled in part by support provided by WestGrid, Com-
pute Ontario and Compute Canada. The authors wish
to recognize and acknowledge the very signiﬁcant cul-
tural role and reverence that the summit of Maunakea
has always had within the indigenous Hawaiian commu-
nity. We are most fortunate to have the opportunity to
conduct observations from this mountain.
REFERENCES
Beuzit, J.-L., Vigan, A., Mouillet, D., et al. 2019,
Astronomy and Astrophysics, 631, A155,
doi: 10.1051/0004-6361/201935251
Bezanson, J., Karpinski, S., Shah, V. B., & Edelman, A.
2012
Fernandes, R. B., Mulders, G. D., Pascucci, I., Mordasini,
C., & Emsenhuber, A. 2019, ApJ, 874, 81,
doi: 10.3847/1538-4357/ab0300
Fletcher, R. 1987, Perth Meridien Observations
Galicher, R., & Marois, C. 2011, P25
Garstka, M., Cannon, M., & Goulart, P. 2019, in European
Control Conference, doi: 10.23919/ECC.2019.8796161
Grant, M., Boyd, S., & Ye, Y. 2006, in Global
Optimization, ed. L. Liberti & N. Maculan, Vol. 84
(Boston: Kluwer Academic Publishers), 155–210,
doi: 10.1007/0-387-30528-9 7
Lafreni`ere, D., Marois, C., Doyon, R., Nadeau, D., &
Artigau, ´E. 2007, The Astrophysical Journal, 660, 770,
doi: 10.1086/513180
Macintosh, B., Graham, J. R., Ingraham, P., et al. 2014,
Proceedings of the National Academy of Science, 111,
12661, doi: 10.1073/pnas.1304215111
Marois, C., Doyon, R., Nadeau, D., Racine, R., & Walker,
G. A. H. 2003, 8, 233, doi: 10.1051/eas:2003067
Marois, C., Doyon, R., Racine, R., & Nadeau, D. 2000,
PUBL ASTRON SOC PAC, 112, 91, doi: 10.1086/316492
Marois, C., Lafreni`ere, D., Doyon, R., Macintosh, B., &
Nadeau, D. 2006a, The Astrophysical Journal, 641, 556,
doi: 10.1086/500401
Marois, C., Lafreni`ere, D., Macintosh, B., & Doyon, R.
2006b, The Astrophysical Journal, 647, 612,
doi: 10.1086/505191
Marois, C., Macintosh, B., Barman, T., et al. 2008, Science,
322, 1348, doi: 10.1126/science.1166585
Marois, C., Macintosh, B., & V´eran, J.-P. 2010a, 7736,
77361J, doi: 10.1117/12.857225
Marois, C., Zuckerman, B., Konopacky, Q. M., Macintosh,
B., & Barman, T. 2010b, Nature, 468, 1080,
doi: 10.1038/nature09684
Meshkat, T., Kenworthy, M. A., Quanz, S. P., & Amara, A.
2014, The Astrophysical Journal, 780, 17,
doi: 10.1088/0004-637X/780/1/17
Mogensen, P. K., & Riseth, A. N. 2018, Journal of Open
Source Software, 3, 615, doi: 10.21105/joss.00615
Nielsen, E. L., Rosa, R. J. D., Wang, J. J., et al. 2020, AJ,
159, 71, doi: 10.3847/1538-3881/ab5b92
Pueyo, L., Crepp, J. R., Vasisht, G., et al. 2012, ApJS, 199,
6, doi: 10.1088/0067-0049/199/1/6
Racine, R., Walker, G. A. H., Nadeau, D., Doyon, R., &
Marois, C. 1999, PASP, 111, 587, doi: 10.1086/316367
Ruﬃo, J.-B., Macintosh, B., Wang, J. J., et al. 2017, ApJ,
842, 14, doi: 10.3847/1538-4357/aa72dd
Sivaramakrishnan, A., & Oppenheimer, B. R. 2006, The
Astrophysical Journal, 647, 620, doi: 10.1086/505192
Skrutskie, M. F., Jones, T., Hinz, P., et al. 2010, in
Ground-Based and Airborne Instrumentation for
Astronomy III, Vol. 7735 (International Society for
Optics and Photonics), 77353H, doi: 10.1117/12.857724
Soummer, R., Pueyo, L., & Larkin, J. 2012, ApJ, 755, L28,
doi: 10.1088/2041-8205/755/2/L28
Udell, M., Mohan, K., Zeng, D., et al. 2014,
arXiv:1410.4821 [cs, math, stat].
https://arxiv.org/abs/1410.4821
Walker, G., Chapman, S., Mandushev, G., et al. 1998,
arXiv:astro-ph/9810443.
https://arxiv.org/abs/astro-ph/9810443

